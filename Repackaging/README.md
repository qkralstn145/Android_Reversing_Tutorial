#Repackaging APP
================
해당 튜토리얼은 리패키징 과정을 통해 제공된 APK파일을 수정해본다.

기존 Java를 통한 정적분석 방식과 Smali를 통해 학습한 내용을 토대로 간단한 시나리오를 통해 앱이 동작하도록 만들어보자.

해당 과정의 이해를 돕기 위해서 APK 파일 구조, 안드로이드 정적 분석, 리패키징, 루팅 탐지에 대해서 간단하게 확인한다.

###APK 파일 구조
APK파일은 ZIP 파일 포맷으로 구성되어 있으며, 크게 아래와 같은 구성요소들을 갖고 있다.

  1./META-INF: 해당 앱을 배포할 때 개발자의 인증서를 통해 서명한 내용을 담고 있다.
  2./res: 컴파일되지 않는 앱의 리소스들이 포함되어 있다. ( ex: 이미지)
  3.AndroidManifest.xml: 해당 앱에 대한 설명, 실행 권한, 앱 구성 요소(Components)들에 대한 정보들을 담고 있다.
  4.classes.dex: Dalvik 가상머신에서 동작할 수 있도록 만들어진 바이너리 코드 형태의 실행 파일
  5.resources.arsc: 컴파일된 리소스 파일

###안드로이드 정적 분석
안드로이드 정적 분석은 크게 두 가지를 확인하는 경우가 존재한다.

  1.	Dalvik Layer: Android API에 대한 정보, Dalvik bytecode instruction
  2.	Native Layer: ELF structure, ARM/x86 instruction

안드로이드는 Java와 C/C++ 언어를 통해 앱 제작이 가능하다. 그렇기에 확인 가능한 Layer 역시 두 가지가 존재하며 이를 Dalvik Layer와 Native Layer로 볼 수 있다.
해당 예제에서는 Dalvik Layer에서만 정적 분석을 실시하며 Native Layer에 대한 내용은 따로 다루지 않는다. 이전 튜토리얼에서 확인했듯이 Java code와 Smali code를 통해서 정적 분석이 가능하며, 역공학을 할 수 있도록 도와주는 도구로 JD-GUI, apktool, dex2jar 등이 존재한다.

Native Layer에서는 ELF Structure와 ARM/x86의 instruction 정보들을 확인하기 위해 주로 IDA 도구를 활용하게 된다.


###리패키징(Repackaging)
리패키징은 다시 패키징한다는 것을 의미한다. 리패키징을 통해 앱을 수정할 수 있으며, 이는 기존 APK 파일에서 기능을 추가 및 삭제하여 업데이트 할 수 있음을 의미한다. 
이러한 리패키징은 아래와 같은 방식들을 통하여 앱을 수정할 수 있게 된다.

  1.	정적 분석 도구를 통한 Java code와 Smali code 분석/동적 분석 도구를 통한 앱 기능 분석 => 정보 수집
  2.	Smali code 혹은 xml 파일 수정
  3.	수정한 APK 파일을 커스텀 키를 통해 리패키징
  4.	변경된 내용이 정확히 동작하는지 확인
  5.	
위에 설명한 4가지 방식을 통해 리패키징을 진행할 수 있다. 

###루팅 탐지

  <해당 내용은 리패키징 과정의 시나리오를 이해하기 위한 설명이다.>
  
정적 분석을 통해 소스코드를 보다 보면 어느 부분을 봐야 하는지 막막할 경우가 많다. 이는 분석하려는 앱과 목적에 따라 다양할 수 있다. 하지만, 공통적으로 확인하는 내용이 존재하는데 그것이 AndroidManifest.xml과 루팅 탐지이다.

안드로이드 앱을 분석하기 위해서는 루팅된 폰이 필요하다. 해당 내용은 디버깅과 비슷한 원리로 생각하는 것이 좋다. 앱을 분석함에 있어 안드로이드 환경보다 낮은 권한을 갖게 된다면, 다른 앱의 영역에 접근하지 못하기에 필요한 정보들을 수집하려고 루팅을 통해 root의 권한을 얻게 된다. 이러한 루팅은 안드로이드 환경에서 가장 기본적인 안티 리버싱 기법으로 볼 수 있다. 즉, 루팅 탐지를 통해 자신의 앱이 분석되는 것을 막을 수 있다.

이러한 루팅 탐지는 앱에서도 소스 코드를 통해 확인할 수 있으며, 그 방식은 다양하게 자리잡고 있다. 해당 앱에서는 환경 변수인 PATH를 사용하여 “su” 문자열이 존재하는지 여부를 확인하는 방식을 사용해 루팅된 폰인지 검사한다.

해당 튜토리얼에서 사용하는 앱은 루팅 탐지를 진행한 후 이를 감지하면 자동으로 앱이 종료된다. 이를 우회하기 위해 리패키징 작업을 통해 루팅이 되어 있는 폰에서도 루팅이 되지 않은 페이지를 띄울 수 있도록 만들어보자.

